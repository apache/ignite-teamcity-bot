<html>
<head>
    <title>Ignite Teamcity - statistics master's branch</title>
    <link rel="icon" href="img/leaf-icon-png-7066.png">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="css/style-1.5.css">

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="js/common-1.6.js"></script>
    <script src="js/testfails-2.0.js"></script>
    <style>
        table {
            width: 50%;
            border-collapse: collapse;
        }
        td, th {

            padding: 3px 7px 2px 7px;
        }
        th {
            text-align: left;
            padding: 5px;
            background-color: #f5f5ff;
            color: #000000;
        }
        tr:nth-child(odd) { background-color: #fafaff; }
    </style>
</head>
<body>
<script>
    var g_shownDataHashCodeHex = ""
    var g_updTimer = null;

    $(document).ready(function() {
        $.getScript("js/testfails-2.0.js", function(data, textStatus, jqxhr){ });

        $( document ).tooltip();
        loadData();
        //todo fix setInterval( function() { checkForUpdate(); }, 30000);

        $.ajax({ url: "rest/branches/version",  success: showVersionInfo, error: showErrInLoadStatus });

        if(g_updTimer==null) {
            g_updTimer=setTimeout(tstTimeout, 3200);
        }
        setInterval(tstTimeout, 10000);
    });

    function tstTimeout() {

        if(g_updTimer!=null) {
            clearTimeout(g_updTimer);
            g_updTimer=null;
        }


        var d = new Date();
        var n = d.getTime();

        // $(document.body).prepend("timeout at "+n+"<br>");


        if(g_updTimer==null) {
            g_updTimer=setTimeout(tstTimeout, 3200);
        }
    }

    function parmsForRest() {
        var curReqParms = "";
        var buildType = findGetParameter("buildType");
        if(buildType!=null) {
            curReqParms += "?buildType=" + buildType;
        }

        var branch = findGetParameter("branch");
        if(branch!=null) {
            curReqParms += "&branch=" + branch;
        }

        var count = findGetParameter("count");
        if(count!=null) {
            curReqParms += "&count=" + count;
        }
        return curReqParms;
    }

    function loadData() {
        var curFailuresUrl = "rest/build/history" + parmsForRest();

        $("#loadStatus").html("<img src='https://www.wallies.com/filebin/images/loading_apple.gif' width=20px height=20px> Please wait");
        $.ajax({
            url: curFailuresUrl,
            success: function(result) {
                if(result.updateRequired || (isDefinedAndFilled(result.runningUpdates) && result.runningUpdates>0)) {
                    setTimeout(checkForUpdate, 3000)
                    $("#loadStatus").html("<img src='https://www.wallies.com/filebin/images/loading_apple.gif' width=20px height=20px> Updating");
                } else {
                    $("#loadStatus").html("");
                }
                showData(result);
                g_shownDataHashCodeHex = isDefinedAndFilled(result.hashCodeHex) ? result.hashCodeHex : "";
            },
            error: showErrInLoadStatus
        });
    }
    function showData(result) {
        $("#statistics").html(showBuildHistory(result));
    }

    function showBuildHistory(result) {
        var res = "<table><tr><th>Id</th><th>Total tests</th><th>Failed tests</th><th>Ignored tests</th>" +
            "<th>Muted tests</th><th>Total issues*</th><th>Total run time</th></tr>";

        for (var i = 0; i < result.length; i++) {
            var build = result[i];

            res += "<tr><td>" + build.id + "</td><td>" + build.testOccurrences.count + "</td>" +
                "<td>" + build.testOccurrences.failed + "</td>" +
                "<td>" + build.testOccurrences.ignored + "</td>" +
                "<td>" + build.testOccurrences.muted + "</td><td>";

            var issuesArr = getRelatedIssues(build.id);
            for(var j = 0; j < issuesArr.length; j++) {
                var issue = issuesArr[j];
                res += "" + (j + 1) + ". <a href='" + issue.url + "'>" + issue.id + "</a><br>"
            }

            res += "</td><td>" + getDuration(getDate(build.finishDate) - getDate(build.startDate)) + "</td></tr>";
        }

        res +="</table><br>* count and the list of TC configurations with links";
        return res;
    }
    
    function getRelatedIssues(buildId) {
        var issuesArr = "";
        $.ajax({
            url: "rest/build/relatedIssues?buildId=" + buildId,
            success: function (result) {
                issuesArr = result;
            },
            async:false
        });
        return issuesArr;
    }

    function getDate(d) {
        return new Date(d.substring(0, 4), d.substring(4, 6), d.substring(6, 8),
            d.substring(9, 11), d.substring(11, 13), d.substring(13, 15));
    }

    function getDuration(ms){
        var sec = ms / 1000;
        var h = sec / 3600 ^ 0;
        var m = (sec - h * 3600) / 60 ^ 0;
        var s = sec - h * 3600 - m * 60;
        return '' + h + 'h ' + m + 'm ' + s + 's';
    }

</script>
<div id="loadStatus"></div>
<div id="statistics"></div>
<div id="version"></div>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ignite Teamcity - comparison master's branch in the date interval</title>
    <link rel="icon" href="img/leaf-icon-png-7066.png">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="css/style-1.5.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="js/common-1.6.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<br>
<br>
<table class="compare"  width="100%">
    <tr>
        <th class="section"  width="15%">DATE INTERVAL</th>
        <th width="5%"></th>
        <th style="text-align: center;" width="40%"><input type='text' name='daterange1'/></th>
        <th style="text-align: center;" width="40%"><input type='text' name='daterange2'/></th>
    </tr><tr><td></td><td></td><td></td></tr>
    <tr><td class="field">DURATION</td>
        <td><img id="clickGraphDuration" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Duration1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="Duration2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphDuration" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphDuration1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphDuration2" width="500" height="200"></svg></td>
    </tr>
    <tr id="showInfo" style="display: none;">
        <td class="section">FEATURES</td><td></td>
        <td style="text-align: center;" id="info1"></td>
        <td style="text-align: center;" id="info2"></td>
    </tr>
    <tr><td class="section">TESTS</td><td></td><td class="title mmm1"></td><td class="title mmm2"></td></tr>
    <tr><td class="field">COUNT</td>
        <td><img id="clickGraphCount" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Count1" data-allow-highlight="false"></td>
        <td class="mmm2 data2" id="Count2" data-allow-highlight="false"></td>
    </tr>
    <tr id="showGraphCount" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphCount1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphCount2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">PASSED</td>
        <td><img id="clickGraphPassed" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Passed1" data-allow-highlight="false"></td>
        <td class="mmm2 data2" id="Passed2" data-allow-highlight="false"></td>
    </tr>
    <tr id="showGraphPassed" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphPassed1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphPassed2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">FAILED</td>
        <td><img id="clickGraphFailed" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Failed1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="Failed2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphFailed" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphFailed1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphFailed2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">IGNORED</td>
        <td><img id="clickGraphIgnored" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Ignored1" data-allow-highlight="false"></td>
        <td class="mmm2 data2" id="Ignored2" data-allow-highlight="false"></td>
    </tr>
    <tr id="showGraphIgnored" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphIgnored1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphIgnored2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">MUTED</td>
        <td><img id="clickGraphMuted" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Muted1" data-allow-highlight="false"></td>
        <td class="mmm2 data2" id="Muted2" data-allow-highlight="false"></td></tr>
    <tr id="showGraphMuted" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphMuted1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphMuted2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="section">PROBLEMS</td><td></td><td class="title mmm1"></td><td class="title mmm2"></td></tr>
    <tr style="display: none;"><td></td><td></td><td></td></tr>
    <tr><td class="field">TOTAL</td>
        <td><img id="clickGraphTT" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="TT1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="TT2" data-allow-highlight="true"></td></tr>
    <tr id="showGraphTT" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphTT1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphTT2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">EXECUTION TIMEOUT</td>
        <td><img id="clickGraphET" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="ET1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="ET2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphET" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphET1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphET2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">JVM CRASH</td>
        <td><img id="clickGraphJC" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="JC1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="JC2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphJC" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphJC1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphJC2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">OOME</td>
        <td><img id="clickGraphOO" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="OO1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="OO2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphOO" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphOO1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphOO2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">EXIT CODE</td>
        <td><img id="clickGraphEC" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="EC1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="EC2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphEC" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphEC1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphEC2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="section">OTHER METRICS</td><td></td><td class="title t1"></td><td class="title t2"></td></tr>
    <tr style="display: none;"><td></td><td></td><td></td></tr>
    <tr><td class="field">RUNS COUNT</td>
        <td></td>
        <td class="t1 data1" id="RunsCount1"></td>
        <td class="t2 data2" id="RunsCount2"></td>
    </tr>
</table><br>
<div id="version"></div>
<script>
    let oneWeekAgo = new Date(),
        twoWeekAgo = new Date(),
        g_updTimer = null;

    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    twoWeekAgo.setDate(twoWeekAgo.getDate() - 14);

    const parseTime = d3.timeParse("%d-%m-%YT%H:%M:%S"),
        formatTime = d3.timeFormat("%d-%m-%Y %H:%M:%S"),
        formatMillisecond = d3.timeFormat(".%L"),
        formatSecond = d3.timeFormat(":%S"),
        formatMinute = d3.timeFormat("%H:%M"),
        formatHour = d3.timeFormat("%H:%M"),
        formatDay = d3.timeFormat("%a %e"),
        formatWeek = d3.timeFormat("%b %e"),
        formatMonth = d3.timeFormat("%B"),
        formatYear = d3.timeFormat("%Y"),
        parseDuration = d3.utcParse("%s");

    const tOcc = ["Count", "Passed", "Failed", "Ignored", "Muted"],
        prOcc = ["TT", "ET", "JC", "OO", "EC"],
        mmmTitle = "min - median - max",
        tTitle = "total",
        duration = "Duration";

    function multiFormat(date) {
        return (d3.timeSecond(date) < date ? formatMillisecond
            : d3.timeMinute(date) < date ? formatSecond
                : d3.timeHour(date) < date ? formatMinute
                    : d3.timeDay(date) < date ? formatHour
                        : d3.timeMonth(date) < date ? (d3.timeWeek(date) < date ? formatDay : formatWeek)
                            : d3.timeYear(date) < date ? formatMonth
                                : formatYear)(date);
    }

    function dateRangePickerParam(data1, data2) {
        return {
            "opens" : 'left',
            "maxSpan": { "days": 7 },
            "locale": {
                "format": "DD/MM/YYYY", "separator": " - ", "applyLabel": "Apply", "cancelLabel": "Cancel",
                "fromLabel": "From", "toLabel": "To", "customRangeLabel": "Custom", "weekLabel": "W",
                "daysOfWeek": [ "Su", "Mo", "Tu", "We", "Th", "Fr", "Sa" ],
                "monthNames": [ "January", "February", "March", "April", "May", "June", "July",
                    "August", "September", "October", "November", "December" ],
                "firstDay": 1
            },
            "startDate": moment(data1).format("DD-MM-YYYY"), "endDate": moment(data2).format("DD-MM-YYYY")
        }
    }

    function getMinMaxMedian(arr) {
        let newArr = arr.slice();
        newArr = newArr.sort(function(a, b){ return a - b; });

        let i = newArr.length / 2;

        let result = {};
        result.median = i % 1 === 0 ? (newArr[i - 1] + newArr[i]) / 2 : newArr[Math.floor(i)];
        result.min = newArr[0];
        result.max = newArr[newArr.length - 1];

        return result;
    }

    function parseMedian(string) {
        let stringMedian = string.substring(string.indexOf("-") + 2, string.lastIndexOf("-") - 1);

        if (stringMedian.indexOf(":") !== -1)
            return (parseInt(stringMedian.split(":")[0]) * 60 + parseInt(stringMedian.split(":")[1])) * 60;
        else
            return parseFloat(stringMedian);
    }

    function printStatistics(num, map, sinceDate, untilDate) {
        clearBackgroundFromAllDataCells();
        clearGraphs(num);

        const anotherNum = (num === 1) ? 2 : 1;

        let statistics = {},
            dates = [],
            buildIds = [];

        statistics[duration] = [];

        for (let i = 0; i < prOcc.length; i++) {
            statistics[prOcc[i]] = [];
            statistics[tOcc[i]] = [];
        }

        for (let j = 0; j < map.length; j++) {
            dates[j] = parseTime(map[j].startDate);
            buildIds[j] = map[j].buildId;
            statistics[duration][j] = map[j].duration;

            for (let i = 0; i < prOcc.length; i++) {
                statistics[prOcc[i]][j] = map[j].totalProblems[prOcc[i]];
                statistics[tOcc[i]][j] = map[j].testOccurrences[tOcc[i].toLowerCase()];
            }
        }

        if (dates.length === 0) {
            printImportantMessage(num, "#ff0000", "No data for the selected period");
            fillAllDataCells(num, "");
            $('.title' + num).html("");

            return;
        } else {
            let firstDate = moment(parseTime(map[0].startDate)).format("DD-MM-YYYY");
            let lastDate = moment(parseTime(map[map.length - 1].startDate)).format("DD-MM-YYYY");

            if ((sinceDate.format("DD-MM-YYYY") !== firstDate) || (untilDate.format("DD-MM-YYYY") !== lastDate)) {
                printImportantMessage(num, "#ffb856", "Data for " +
                    (firstDate === lastDate ? firstDate : ("the period from " + firstDate + " to " + lastDate)) + "");
            } else {
                $("#info" + num).html("");
                if ($('#info' + anotherNum).text() === ''){
                    $('#showInfo').css('display', 'none')
                }
            }
        }

        $('.title.mmm' + num).html(mmmTitle);
        $('.mmm' + num).prop('title', mmmTitle);
        $('.title.t' + num).html(tTitle);
        $('.t' + num).prop('title', tTitle);

        fillCellWithStatistics(duration, num, statistics, dates, buildIds);

        for (let i = 0; i < prOcc.length; i++) {
            fillCellWithStatistics(prOcc[i], num, statistics, dates, buildIds);
            fillCellWithStatistics(tOcc[i], num, statistics, dates, buildIds);
        }

        $('#RunsCount' + num).html(map.length);
    }

    function fillCellWithStatistics(prefix, num, statistics, dates, buildIds) {
        let result = getMinMaxMedian(statistics[prefix]);

        if (prefix === duration)
            $('#' + prefix + num).html(time(result.min) + " - " + time(result.median) + " - " + time(result.max));
        else
            $('#' + prefix + num).html(result.min + " - " + result.median +  " - " + result.max);

        compareAndHighlight(prefix, num, result.median);

        drawGraph(prefix, num, dates, statistics[prefix], buildIds);

        function time(ms){
            return moment(ms * 1000).utcOffset(0).format("H:mm");
        }
    }

    function compareAndHighlight(prefix, thisNum, thisMedian){
        let anotherNum = (thisNum === 1) ? 2 : 1,
            thisElement = $('#' + prefix + thisNum),
            anotherElement =  $('#' + prefix + anotherNum);

        if (thisElement.data('allowHighlight').toString() === "true") {
            let anotherMedian = parseMedian(anotherElement.text());
            if (!isNaN(anotherMedian)) {
                if (thisMedian > anotherMedian) {
                    thisElement.css('background-color', '#ffeee9');
                    anotherElement.css('background-color', '#e5ffe8');
                } else if (thisMedian < anotherMedian) {
                    anotherElement.css('background-color', '#ffeee9');
                    thisElement.css('background-color', '#e5ffe8');
                }
            }
        }
    }

    $(document).ready(function() {
        loadData(1, moment(oneWeekAgo), moment());
        loadData(2, moment(twoWeekAgo), moment(oneWeekAgo));

        $.ajax({ url: "rest/branches/version",  success: showVersionInfo, error: showErrInLoadStatus });

        if(g_updTimer == null) {
            g_updTimer = setTimeout(tstTimeout, 3200);
        }
        setInterval(tstTimeout, 10000);
    });

    function tstTimeout() {
        if (g_updTimer != null) {
            clearTimeout(g_updTimer);
            g_updTimer = null;
        }

        if (g_updTimer == null) {
            g_updTimer = setTimeout(tstTimeout, 3200);
        }
    }
    
    function clearBackgroundFromAllDataCells(num){
        $('.data' + (num == null ? '1, .data2' : num)).css('background', '');
    }
    
    function fillAllDataCells(num, message) {
        $('.data' + num).html(message);
    }

    function clearGraphs(num) {
        $("#graph" + duration + num).empty();
        for (let i = 0; i < prOcc.length; i++) {
            $("#graph" + prOcc[i] + num).empty();
            $("#graph" + tOcc[i] + num).empty();
        }
    }

    function loadGif(num) {
        clearBackgroundFromAllDataCells();
        clearGraphs(num);
        fillAllDataCells(num, "<img src='/img/loading.gif' width=15px height=15px>");
    }

    function printImportantMessage(num, color, message) {
        $('#info' + num).html("<span style='background:" + color + "; color:white; font-weight:bold;'>" +
            "&nbsp;&nbsp;!&nbsp;&nbsp;</span>&nbsp;&nbsp;" + message);
        $('#showInfo').css('display', '');
    }

    function loadData(num, sinceDate, untilDate) {
        loadGif(num);
        $.ajax(
            {
                url: 'rest/build/history?sinceDate=' + sinceDate.format("DDMMYYYY") +
                '000001&untilDate=' + untilDate.format("DDMMYYYY") + '235959',
                success: function (result) {
                    printStatistics(num, result, sinceDate, untilDate);
                },
                error: showErrInLoadStatus
            }
        );
    }

    $(function() {
        $('input[name="daterange1"]').daterangepicker(
            dateRangePickerParam(oneWeekAgo, new Date()), function (start, end, label) {
                loadData(1, start, end);
            });
    });

    $(function() {
        $('input[name="daterange2"]').daterangepicker(
            dateRangePickerParam(twoWeekAgo, oneWeekAgo), function (start, end, label) {
                loadData(2, start, end);
            });
    });

    graphSpoiler(duration);

    for (let i = 0; i < prOcc.length; i++) {
        graphSpoiler(prOcc[i]);
        graphSpoiler(tOcc[i]);
    }
    
    function graphSpoiler(prefix) {
        $("#clickGraph" + prefix).click(function() {
            let element = $('#showGraph' + prefix);
            element.css('display') === 'none' ? element.css('display', '') : element.css('display', 'none');
        });
    }

    function drawGraph(prefix, num, dates, counts, buildIds) {
        let data = [],
            isDuration = prefix === duration;

        for (let i = 0; i < dates.length; i++) {
            data[i] = {};
            data[i].date = dates[i];
            data[i].value = (isDuration ? parseDuration(parseInt(counts[i])) : counts[i]);
            data[i].buildId = buildIds[i];
        }

        let svg = d3.select("#graph" + prefix + num).append("svg:svg"),
            margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = 500 - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        let div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        let y = (isDuration ? d3.scaleTime() : d3.scaleLinear()).range([height, 0]),
            x = d3.scaleTime().rangeRound([0, width]);

        let line = d3.line()
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.value); });

        x.domain(d3.extent(data, function(d) { return d.date; }));
        y.domain(d3.extent(data, function(d) { return d.value; }));

        g.append("svg:g").attr("transform", "translate(0," + (height) + ")")
            .call(d3.axisBottom(x).tickFormat(multiFormat));
        g.append("svg:g").call(isDuration ? d3.axisLeft(y).tickFormat(d3.utcFormat("%H:%M")) : d3.axisLeft(y));

        let svg_aline = g.append("line")
            .attr("class", "line")
            .style("stroke-dasharray", ("3, 10"))
            .attr("x1",100)
            .attr("x2",400)
            .attr("y1",200)
            .attr("y2",200)
            .style("display", "None");

        g.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-linejoin", "round")
            .attr("stroke-linecap", "round")
            .attr("stroke-width", 1.5)
            .attr("d", line);

        g.selectAll("dot").data(data)
            .enter()
            .append("circle")
            .attr("r", 3)
            .attr("cx", function(d){return x(d.date); })
            .attr("cy", function(d){return y(d.value); })
            .attr("class", "dot")
            .on("mouseover", function(d) {
                d3.select(this).transition().duration(100)
                    .style("fill", "green")
                    .attr("r", 5)
                    .attr("onclick", "checkAvailable(" + d.buildId + "," +  d.date.getTime() + ");" +
                    "return false;");
                div.transition()
                    .duration(200)
                    .style("opacity", .8);

                let graphTd = document.getElementById("graph" + prefix + num).getBoundingClientRect(),
                    scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                div	.html(formatTime(d.date))
                    .style("left", graphTd.left + x(d.date) + (x(d.date) > (500 - 150) ? -150 : 0) + "px")
                    .style("top", scrollTop + graphTd.top - 10 + "px" );
                svg_aline.transition().duration(10)
                    .style("display", "block")
                    .attr("x1", x(d.date))
                    .attr("y1", y(d.value))
                    .attr("x2", x(d.date))
                    .attr("y2", height)
            })

            .on("mouseout", function(d) {
                d3.select(this).transition().duration(100)
                    .style("fill", "grey")
                    .attr("r", 3);
                div.transition()
                    .duration(500)
                    .style("opacity", 0);
                svg_aline.style("display","None")
            });
    }

    function getBuildLink(buildId) { return "https://ci.ignite.apache.org/viewLog.html?buildId=" + buildId
            + "&tab=buildResultsDiv&buildTypeId=IgniteTests24Java8_RunAll"; }

    function checkAvailable(buildId, date) {
        let dateDiff = moment().diff(moment(date), 'days');

        if (dateDiff <= 14) {
            window.open(getBuildLink(buildId), '_blank');

            return;
        }

        let message = "<p style='text-align:center;opacity: 0.7;'><img src='img/tc.svg' width='100' height='100'></p>" +
            "<br>The results &laquo;Run All&raquo; for <b>build [" + buildId +  "]</b> is <b>not available</b> on " +
            "the TeamCity server.<br><br><span style='color:grey;font-size:smaller'><hr>TeamCity server stores data " +
            "for the last ~14 days. Since the launch of the build " + dateDiff + " days have passed</span>";

        let modalDialog = $("#modalDialog");

        modalDialog.html(message);
        modalDialog.dialog({
            modal: true,
            buttons: {
                "Go anyway": function () {
                    $(this).dialog("close");
                    window.open(getBuildLink(buildId), '_blank');
                },
                "Cancel": function () {
                    $(this).dialog("close");
                }
            }
        });
    }
</script>
<div style="visibility:hidden"><div id="modalDialog" title="Information"></div></div>
</body>
</html>

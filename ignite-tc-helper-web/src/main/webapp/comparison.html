<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ignite Teamcity - comparison master's branch in the date interval</title>
    <link rel="icon" href="img/leaf-icon-png-7066.png">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="css/style-1.5.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script src="js/common-1.6.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<br>
<br>
<table style="table-layout: fixed; width: 100%" class="compare">
    <tr>
        <th class="section"  width="15%">DATE INTERVAL</th>
        <th width="5%"></th>
        <th style="text-align: center;" width="40%"><input type='text' name='daterange1'/></th>
        <th style="text-align: center;" width="40%"><input type='text' name='daterange2'/></th>
    </tr>
    <tr style="display: none;"></tr><tr style="display: none;"></tr><tr style="display: none;"></tr>
    <tr id="showInfo" style="display: none;">
        <td class="section">FEATURES</td><td></td>
        <td style="text-align: center;" id="info1"></td>
        <td style="text-align: center;" id="info2"></td>
    </tr>
    <tr><td class="section">TESTS</td><td></td><td class="title1"></td><td class="title2"></td></tr>
    <tr><td class="field">COUNT</td>
        <td><img id="clickGraphCount" src='/img/browser.png'></td>
        <td class="data1" id="Count1" title="min - median - max" data-allow-highlight="false"></td>
        <td class="data2" id="Count2" title="min - median - max" data-allow-highlight="false"></td>
    </tr>
    <tr id="showGraphCount" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphCount1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphCount2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">PASSED</td>
        <td><img id="clickGraphPassed" src='/img/browser.png'></td>
        <td class="data1" id="Passed1" title="min - median - max" data-allow-highlight="false"></td>
        <td class="data2" id="Passed2" title="min - median - max" data-allow-highlight="false"></td>
    </tr>
    <tr id="showGraphPassed" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphPassed1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphPassed2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">FAILED</td>
        <td><img id="clickGraphFailed" src='/img/browser.png'></td>
        <td class="data1" id="Failed1" title="min - median - max" data-allow-highlight="true"></td>
        <td class="data2" id="Failed2" title="min - median - max" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphFailed" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphFailed1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphFailed2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">IGNORED</td>
        <td><img id="clickGraphIgnored" src='/img/browser.png'></td>
        <td class="data1" id="Ignored1" title="min - median - max" data-allow-highlight="false"></td>
        <td class="data2" id="Ignored2" title="min - median - max" data-allow-highlight="false"></td>
    </tr>
    <tr id="showGraphIgnored" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphIgnored1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphIgnored2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">MUTED</td>
        <td><img id="clickGraphMuted" src='/img/browser.png'></td>
        <td class="data1" id="Muted1" title="min - median - max" data-allow-highlight="false"></td>
        <td class="data2" id="Muted2" title="min - median - max" data-allow-highlight="false"></td></tr>
    <tr id="showGraphMuted" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphMuted1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphMuted2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="section">PROBLEMS</td><td></td><td class="title1"></td><td class="title2"></td></tr>
    <tr style="display: none;"><td></td><td></td><td></td></tr>
    <tr><td class="field">TOTAL</td>
        <td><img id="clickGraphTT" src='/img/browser.png'></td>
        <td class="data1" id="TT1" title="min - median - max" data-allow-highlight="true"></td>
        <td class="data2" id="TT2" title="min - median - max" data-allow-highlight="true"></td></tr>
    <tr id="showGraphTT" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphTT1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphTT2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">EXECUTION TIMEOUT</td>
        <td><img id="clickGraphET" src='/img/browser.png'></td>
        <td class="data1" id="ET1" title="min - median - max" data-allow-highlight="true"></td>
        <td class="data2" id="ET2" title="min - median - max" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphET" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphET1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphET2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">JVM CRASH</td>
        <td><img id="clickGraphJC" src='/img/browser.png'></td>
        <td class="data1" id="JC1" title="min - median - max" data-allow-highlight="true"></td>
        <td class="data2" id="JC2" title="min - median - max" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphJC" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphJC1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphJC2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">OOME</td>
        <td><img id="clickGraphOO" src='/img/browser.png'></td>
        <td class="data1" id="OO1" title="min - median - max" data-allow-highlight="true"></td>
        <td class="data2" id="OO2" title="min - median - max" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphOO" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphOO1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphOO2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">EXIT CODE</td>
        <td><img id="clickGraphEC" src='/img/browser.png'></td>
        <td class="data1" id="EC1" title="min - median - max" data-allow-highlight="true"></td>
        <td class="data2" id="EC2" title="min - median - max" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphEC" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphEC1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphEC2" width="500" height="200"></svg></td>
    </tr>
</table><br>
<table style="table-layout: fixed; width: 100%" id="testsTable" class="testsTable">
    <tbody>
    <tr>
        <th class="section" width="15%" style="vertical-align: middle; text-align: left; padding: 5px">FAILED TESTS</th>
        <th width="5%"></th>
        <th width="40%"></th>
        <th width="40%"></th>
        </tr>
    </tbody>
</table>

<div id="version"></div>
<script>
    const TESTS_TABLE = '#testsTable';
    let oneWeekAgo = new Date();
    let twoWeekAgo = new Date();
    let g_updTimer = null;

    /** Structure for storing tests by suites parsed response for every date interval. */
    let mergedTestsResults = {1 : {}, 2 : {} };


    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    twoWeekAgo.setDate(twoWeekAgo.getDate() - 14);

    function dateRangePickerParam(data1, data2) {
        return {
            "maxSpan": { "days": 7 },
            "locale": {
                "format": "DD/MM/YYYY", "separator": " - ", "applyLabel": "Apply", "cancelLabel": "Cancel",
                "fromLabel": "From", "toLabel": "To", "customRangeLabel": "Custom", "weekLabel": "W",
                "daysOfWeek": [ "Su", "Mo", "Tu", "We", "Th", "Fr", "Sa" ],
                "monthNames": [ "January", "February", "March", "April", "May", "June", "July",
                    "August", "September", "October", "November", "December" ],
                "firstDay": 1
            },
            "startDate": moment(data1).format("DD-MM-YYYY"), "endDate": moment(data2).format("DD-MM-YYYY")
        }
    }

    const prOcc = ["TT", "ET", "JC", "OO", "EC"];
    const tOcc = ["Count", "Passed", "Failed", "Ignored", "Muted"];

    function getMinMaxMedian(arr) {
        let newArr = arr.slice();
        newArr = newArr.sort(function(a, b){ return a - b; });
        let i = newArr.length / 2;
        let result = {};
        result.median = i % 1 == 0 ? (newArr[i - 1] + newArr[i]) / 2 : newArr[Math.floor(i)];
        result.min = newArr[0];
        result.max = newArr[newArr.length - 1];
        return result;
    }

    function parseMedian(string) {
        return parseFloat(string.substring(string.indexOf("-") + 2, string.lastIndexOf("-") - 1));
    }

    var changeDisplay = function(id) {
        $('*[id=' + id + ']').each(function() {
            $(this).toggle();
        });
    }

    function mergeSuits(results) {
        let mergedSuites = new Set();

        for (let key of Object.keys(results)) {
            for (let suite of Object.keys(results[key]))
                mergedSuites.add(suite);
        }

        return Array.from(mergedSuites);
    }

    function printTests(results) {
        $(TESTS_TABLE + " tr:not(:first-child)").remove();

        let markedRow = true;

        for (let suite of mergeSuits(results).sort()) {
            let suiteName = suite.split('_').filter((value, index) => index != 0).join('_');
            let testsCntCells = '';
            let testsCells = '';

            for (let key of Object.keys(results)) {
                let obj = results[key];
                let testLength = !obj.hasOwnProperty(suite) || obj[suite].length == 0 ?
                    '' : obj[suite].length;

                testsCntCells = testsCntCells + '<td class="testsCntCell"><p id="' + suite + '">' + testLength + '</p></td>';

                testsCells = testsCells + '<td class="testsCell">' + getSuiteTestsHtml(results, suite, key) + '</td>'
            }

            $(TESTS_TABLE + " > tbody:last-child").append('<tr class="testsCntRow" onclick="changeDisplay(\'' + suite + '\')">' +
                '<td class = "suiteCell">' + suiteName + '</td>' +
                '<td></td>' + testsCntCells + '</tr>');

            $(TESTS_TABLE + " > tbody:last-child").append('<tr class="testsRow" id="' + suite + '">' +
                '<td class="testsSuiteCell" onclick="changeDisplay(\'' + suite + '\')"></td>' +
                '<td></td>' + testsCells + '</tr>');
        }
    }

    function generateCompareTestsResults(results) {
        let compareTestsResults = {};

        for (let key of  Object.keys(results)) {
            let uniqueObj = {};

            for (let suite of  Object.keys(results[key])) {
                let allTests = [];

                for (let key2 of Object.keys(results)) {
                    if (key == key2)
                        continue;

                    allTests = allTests.concat(results[key2][suite]);
                }

                let uniqTests = results[key][suite].filter(function(test) {
                    return allTests.indexOf(test) == -1;
                });

                if (uniqTests.length != 0)
                    uniqueObj[suite] = uniqTests;
            }

            compareTestsResults[key] = uniqueObj;
        }

        return compareTestsResults;
    }

    function getSuiteTestsHtml(results, suite, key) {
        if (!results[key].hasOwnProperty(suite) || results[key][suite].length == 0)
            return '';

        let res = '<body><div  id="' + suite + key + '"style="cursor: default; margin-left: 10px;">';

        for (let test of results[key][suite].sort()) {
            let list = test.toString().split(".");

            if (list.length < 2)
                list = test.toString().split(":");

            let testName = list.pop();
            let testClass = list.pop();

            res += '<p align="left" title="' + test + '">' + testClass + '.' + testName +
                '<a href="#" onclick="getTestRef(\'' + test + '\'' + ',\'' + suite + '\'); return false;">' +
                ' &gt&gt</a>' + '</p>'
        }

        res += '</div></body>';

        return res;
    }

    function getTestRef(testName, suite) {
        let res = null;

        $.ajax({
                async: false,
                url: 'rest/build/testRef?testName=' + testName + '&suiteName=' + suite,
                success: function (result) {
                    res = result;
                },
                error: showErrInLoadStatus
            }
        );

        if (res == null) {
            alert("No available data for that test. Try later.");

            return;
        }

        window.open(res);
    }

    function printStatistics(num, map, sinceDate, untilDate) {
        clearBackgroundFromAllDataCells();
        clearGraphs(num);

        const anotherNum = (num === 1) ? 2 : 1;
        const parseTime = d3.timeParse("%d-%m-%YT%H:%M:%S");

        let statistics = {};
        let dates = [];

        for (let i = 0; i < prOcc.length; i++) {
            statistics[prOcc[i]] = [];
            statistics[tOcc[i]] = [];
        }

        for (let j = 0; j < map.length; j++) {
            dates[j] = parseTime(map[j].startDate);

            for (let i = 0; i < prOcc.length; i++) {
                statistics[prOcc[i]][j] = map[j].totalProblems[prOcc[i]];
                statistics[tOcc[i]][j] = map[j].testOccurrences[tOcc[i].toLowerCase()];
            }
        }

        if (dates.length === 0) {
            printImportantMessage(num, "#ff0000", "No data for the selected period");
            fillAllDataCells(num, "");
            $('.title' + num).html("");

            return;
        } else {
            let firstDate = moment(parseTime(map[0].startDate)).format("DD-MM-YYYY");
            let lastDate = moment(parseTime(map[map.length - 1].startDate)).format("DD-MM-YYYY");

            if ((sinceDate.format("DD-MM-YYYY") !== firstDate) || (untilDate.format("DD-MM-YYYY") !== lastDate)) {
                printImportantMessage(num, "#ffb856", "Data for " +
                    (firstDate === lastDate ? firstDate : ("the period from " + firstDate + " to " + lastDate)) + "");
            } else {
                $("#info" + num).html("");
                if ($('#info' + anotherNum).text() === ''){
                    $('#showInfo').css('display', 'none')
                }
            }
        }

        $('.title' + num).html('min - median - max');

        for (let i = 0; i < prOcc.length; i++) {
            fillCellWithStatistics(prOcc[i], num, statistics, dates);
            fillCellWithStatistics(tOcc[i], num, statistics, dates);
        }
    }

    function fillCellWithStatistics(prefix, num, statistics, dates) {
        let result = getMinMaxMedian(statistics[prefix]);

        $('#' + prefix + num).html(result.min + " - " + result.median +  " - " + result.max);

        compareAndHighlight(prefix, num, result.median);

        drawGraph(prefix, num, dates, statistics[prefix], prefix);
    }

    function compareAndHighlight(prefix, thisNum, thisMedian){
        let anotherNum = (thisNum === 1) ? 2 : 1;

        let thisElement = $('#' + prefix + thisNum);
        let anotherElement =  $('#' + prefix + anotherNum);

        if (thisElement.data('allowHighlight').toString() === "true") {
            let anotherMedian = parseMedian(anotherElement.text());
            if (!isNaN(anotherMedian)) {
                if (thisMedian > anotherMedian) {
                    thisElement.css('background-color', '#ffeee9');
                    anotherElement.css('background-color', '#e5ffe8');
                } else if (thisMedian < anotherMedian) {
                    anotherElement.css('background-color', '#ffeee9');
                    thisElement.css('background-color', '#e5ffe8');
                }
            }
        }
    }

    $(document).ready(function() {
        loadData(1, moment(oneWeekAgo), moment());
        loadData(2, moment(twoWeekAgo), moment(oneWeekAgo));

        $.ajax({ url: "rest/branches/version",  success: showVersionInfo, error: showErrInLoadStatus });

        if(g_updTimer == null) {
            g_updTimer = setTimeout(tstTimeout, 3200);
        }
        setInterval(tstTimeout, 10000);
    });

    function tstTimeout() {
        if (g_updTimer != null) {
            clearTimeout(g_updTimer);
            g_updTimer = null;
        }

        if (g_updTimer == null) {
            g_updTimer = setTimeout(tstTimeout, 3200);
        }
    }
    
    function clearBackgroundFromAllDataCells(num){
        $('.data' + (num == null ? '1, .data2' : num)).css('background', '');
    }
    
    function fillAllDataCells(num, message) {
        $('.data' + num).html(message);
        $('.testsCntCell').html(message);
    }

    function clearGraphs(num) {
        for (let i = 0; i < prOcc.length; i++) {
            $("#graph" + prOcc[i] + num).empty();
            $("#graph" + tOcc[i] + num).empty();
        }
    }

    function loadGif(num) {
        clearBackgroundFromAllDataCells();
        clearGraphs(num);
        fillAllDataCells(num, "<img src='/img/loading.gif' width=15px height=15px>");
    }

    function printImportantMessage(num, color, message) {
        $('#info' + num).html("<span style='background:" + color + "; color:white; font-weight:bold;'>" +
            "&nbsp;&nbsp;!&nbsp;&nbsp;</span>&nbsp;&nbsp;" + message);
        $('#showInfo').css('display', '');
    }

    function loadData(num, sinceDate, untilDate) {
        loadGif(num);

        mergedTestsResults[num] = {};

        $.ajax({
                url: 'rest/build/history?sinceDate=' + sinceDate.format("DDMMYYYY") +
                    '000001&untilDate=' + untilDate.format("DDMMYYYY") + '235959',
                success: function (result) {
                    printStatistics(num, result.buildsStatistics, sinceDate, untilDate);

                    try {
                        mergedTestsResults[num] = JSON.parse(result.mergedTestsJson);
                    } catch (e) {
                        printImportantMessage(num, "#ff0000", "Invalid server response. Unable to parse JSON");
                    }

                    printTests(generateCompareTestsResults(mergedTestsResults));
                },
                error: showErrInLoadStatus,
                timeout: 1800000
            }
        );
    }

    $(function() {
        $('input[name="daterange1"]').daterangepicker(
            dateRangePickerParam(oneWeekAgo, new Date()), function (start, end, label) {
                loadData(1, start, end);
            });
    });

    $(function() {
        $('input[name="daterange2"]').daterangepicker(
            dateRangePickerParam(twoWeekAgo, oneWeekAgo), function (start, end, label) {
                loadData(2, start, end);
            });
    });

    for (let i = 0; i < prOcc.length; i++) {
        graphSpoiler(prOcc[i]);
        graphSpoiler(tOcc[i]);
    }
    
    function graphSpoiler(prefix) {
        $("#clickGraph" + prefix).click(function() {
            let element = $('#showGraph' + prefix);
            element.css('display') === 'none' ? element.css('display', '') : element.css('display', 'none');
        });
    }

    function drawGraph(prefix, num, dates, counts, text) {
        let data = [];

        for (let i = 0; i < dates.length; i++) {
            data[i] = {};
            data[i].date = dates[i];
            data[i].count = counts[i];
        }
        svg = d3.select("#graph" + prefix + num).append("svg:svg");
        margin = {top: 20, right: 20, bottom: 30, left: 50};
        width = +500 - margin.left - margin.right;
        height = +200 - margin.top - margin.bottom;
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        x = d3.scaleTime().range([0, width]);
        y = d3.scaleLinear().range([height, 0]);

        line = d3.line()
            .curve(d3.curveBasis)
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.count); });


        x.domain(d3.extent(data, function(d) { return d.date; }));
        y.domain(d3.extent(data, function(d) { return d.count; }));

        g.append("svg:g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x))
            .select(".domain")
            .remove();

        g.append("svg:g")
            .call(d3.axisLeft(y))
            .append("text")
            .attr("fill", "#000")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end")
            .text(text);

        g.append("svg:path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-linejoin", "round")
            .attr("stroke-linecap", "round")
            .attr("stroke-width", 1.5)
            .attr("d", line);
    }
</script>
</body>
</html>

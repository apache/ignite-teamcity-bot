<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ignite Teamcity - comparison master's branch in the date interval</title>
    <link rel="icon" href="img/leaf-icon-png-7066.png">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="css/style-1.5.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script src="js/common-1.6.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<br>
<br>
<table class="stat">
    <tr>
        <th class="section">DATE INTERVAL</th>
        <th style="text-align: center;"><input type='text' name='daterange1'/></th>
        <th style="text-align: center;"><input type='text' name='daterange2'/></th>
    </tr>
    <tr><td class="section">TESTS</td><td></td><td></td></tr>
    <tr><td class="field">COUNT</td>
        <td class="data1" id="count1" title="min - median - max"></td>
        <td class="data2" id="count2" title="min - median - max"></td>
    </tr>
    <tr><td class="field">PASSED</td>
        <td class="data1" id="passed1" title="min - median - max"></td>
        <td class="data2" id="passed2" title="min - median - max"></td>
    </tr>
    <tr><td class="field">FAILED</td>
        <td class="data1" id="failed1" title="min - median - max"></td>
        <td class="data2" id="failed2" title="min - median - max"></td>
    </tr>
    <tr><td class="field">IGNORED</td>
        <td class="data1" id="ignored1" title="min - median - max"></td>
        <td class="data2" id="ignored2" title="min - median - max"></td>
    </tr>
    <tr><td class="field">MUTED</td>
        <td class="data1" id="muted1" title="min - median - max"></td>
        <td class="data2" id="muted2" title="min - median - max"></td></tr>
    <tr><td class="section">PROBLEMS</td><td></td><td></td></tr>
    <tr><td class="field">TOTAL</td>
        <td class="data1" id="TT1" title="min - median - max"></td>
        <td class="data2" id="TT2" title="min - median - max"></td></tr>
    <tr><td></td>
        <td style="text-align: center;"><svg id="graphTT1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphTT2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">SUBTOTAL<br><p style="font-size:10px">WITHOUT FAILED TESTS, SNAPSHOT DEPENDENCY ERROR, OTHER</p></td>
        <td class="data1" id="ST1" title="min - median - max"></td>
        <td class="data2" id="ST2" title="min - median - max"></td></tr>
    <tr><td></td>
        <td style="text-align: center;"><svg id="graphST1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphST2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">EXECUTION_TIMEOUT</td>
        <td class="data1" id="ET1" title="min - median - max"></td>
        <td class="data2" id="ET2" title="min - median - max"></td>
    </tr>
    <tr><td class="field">JVM_CRASH</td>
        <td class="data1" id="JC1" title="min - median - max"></td>
        <td class="data2" id="JC2" title="min - median - max"></td>
    </tr>
    <tr><td class="field">OOME</td>
        <td class="data1" id="OO1" title="min - median - max"></td>
        <td class="data2" id="OO2" title="min - median - max"></td>
    </tr>
    <tr><td class="field">EXIT_CODE</td>
        <td class="data1" id="EC1" title="min - median - max"></td>
        <td class="data2" id="EC2" title="min - median - max"></td>
    </tr>
    <tr><td class="field">FAILED_TESTS</td>
        <td class="data1" id="FT1" title="min - median - max"></td>
        <td class="data2" id="FT2" title="min - median - max"></td>
    </tr>
    <tr><td class="field">SNAPSHOT_DEPENDENCY_ERROR</td>
        <td class="data1" id="SD1" title="min - median - max"></td>
        <td class="data2" id="SD2" title="min - median - max"></td>
    </tr>
    <tr><td class="field">OTHER</td>
        <td class="data1" id="OT1" title="min - median - max"></td>
        <td class="data2" id="OT2" title="min - median - max"></td></tr>
</table><br>
<div>
    <details><summary>log1</summary><p id="log1"></p></details>
    <details><summary>log2</summary><p id="log2"></p></details>
</div>
<div id="version"></div>
<script>
    let oneWeekAgo = new Date();
    let twoWeekAgo = new Date();

    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    twoWeekAgo.setDate(twoWeekAgo.getDate() - 14);

    function dateRangePickerParam(data1, data2) {
        return {
            "maxSpan": { "days": 7 },
            "locale": {
                "format": "DD/MM/YYYY", "separator": " - ", "applyLabel": "Apply", "cancelLabel": "Cancel",
                "fromLabel": "From", "toLabel": "To", "customRangeLabel": "Custom", "weekLabel": "W",
                "daysOfWeek": [ "Su", "Mo", "Tu", "We", "Th", "Fr", "Sa" ],
                "monthNames": [ "January", "February", "March", "April", "May", "June", "July",
                    "August", "September", "October", "November", "December" ],
                "firstDay": 1
            },
            "startDate": moment(data1).format("DD-MM-YYYY"), "endDate": moment(data2).format("DD-MM-YYYY")
        }
    }

    const prOcc = ["TT", "ET", "JC", "OO", "EC", "FT", "SD", "OT"];
    const tOcc = ["count", "passed", "failed", "ignored", "muted"];

    function getMinMaxMedian(arr) {
        let newArr = arr.slice();
        newArr = newArr.sort(function(a, b){ return a - b; });
        let i = newArr.length / 2;
        let result = {};
        result.median = i % 1 == 0 ? (newArr[i - 1] + newArr[i]) / 2 : newArr[Math.floor(i)];
        result.min = newArr[0];
        result.max = newArr[newArr.length - 1];
        return result;
    }

    function parseMedian(string) {
        return parseInt(string.substring(string.indexOf("-") + 2, string.lastIndexOf("-") - 1))
    }

    function printStatistics(num, map) {
        const parseTime = d3.timeParse("%d-%m-%YT%H:%M:%S");

        let statistics = {};
        let dates = [];

        for (let i = 0; i < prOcc.length; i++) {
            statistics[prOcc[i]] = [];
        }

        for (let k = 0; k < tOcc.length; k++) {
            statistics[tOcc[k]] = [];
        }

        statistics['ST'] = [];

        for (let j = 0; j < map.length; j++) {
            dates[j] = parseTime(map[j].date)

            for (let i = 0; i < prOcc.length; i++) {
                statistics[prOcc[i]][j] = map[j].totalProblems[prOcc[i]];
            }

            for (let k = 0; k < tOcc.length; k++) {
                statistics[tOcc[k]][j] = map[j].testOccurrences[tOcc[k]];
            }

            statistics['ST'][j] = statistics['TT'][j] - statistics['FT'][j] - statistics['SD'][j];
        }

        const anotherNum = (num === 1) ? 2 : 1;
        let anotherMedian;
        let result = {};

        for (let i = 0; i < prOcc.length; i++) {

            document.getElementById(prOcc[i] + 1).style.background = null;
            document.getElementById(prOcc[i] + 2).style.background = null;

            result = getMinMaxMedian(statistics[prOcc[i]]);
            anotherMedian = parseMedian(document.getElementById(prOcc[i] + anotherNum).innerHTML);

            $('#' + prOcc[i] + num).html(result.min + " - " + result.median +  " - " + result.max);

            if (!isNaN(anotherMedian)){
                if (result.median > anotherMedian){
                    document.getElementById(prOcc[i] + num).style.backgroundColor = "#ffeee9";
                } else if (result.median < anotherMedian){
                    document.getElementById(prOcc[i] + anotherNum).style.backgroundColor = "#ffeee9";
                }
            }
        }

        for (let k = 0; k < tOcc.length; k++) {
            result = getMinMaxMedian(statistics[tOcc[k]]);

            $('#' + tOcc[k] + num).html(result.min + " - " + result.median + " - " + result.max);
        }

        result = getMinMaxMedian(statistics['ST']);

        $('#' + 'ST' + num).html(result.min + " - " + result.median + " - " + result.max);

        drawGraph('TT', num, dates, statistics['TT'], "TOTAL");
        drawGraph('ST', num, dates, statistics['ST'], "SUBTOTAL");
    }

    $(document).ready(function() {
        loadData(1, moment(oneWeekAgo).format("DDMMYYYY"), moment().format("DDMMYYYY"));
        loadData(2, moment(twoWeekAgo).format("DDMMYYYY"), moment(oneWeekAgo).format("DDMMYYYY"));
    });

    function loadGif(num) {
        $('.data' + num).html("<img src='/img/loading.gif' width=15px height=15px>");
    }

    function loadData(num, sinceDate, untilDate) {
        loadGif(num);
        $.ajax(
            {
                url: 'rest/build/history?sinceDate=' + sinceDate + '000001&untilDate=' + untilDate + '235959',
                success: function (result) {
                    $('#log' + num).html(JSON.stringify(result));
                    printStatistics(num, result);
                },
                complete: function (result) {
                    // do something, not critical.
                }
            }
        );
    }

    $(function() {
        $('input[name="daterange1"]').daterangepicker(
            dateRangePickerParam(oneWeekAgo, new Date()), function (start, end, label) {
                loadData(1, start.format("DDMMYYYY"), end.format("DDMMYYYY"));
            });
    });

    $(function() {
        $('input[name="daterange2"]').daterangepicker(
            dateRangePickerParam(twoWeekAgo, oneWeekAgo), function (start, end, label) {
                loadData(2, start.format("DDMMYYYY"), end.format("DDMMYYYY"));
            });
    });

    function drawGraph(prefix, num, dates, counts, text) {
        let data = [];

        for (let i = 0; i < dates.length; i++) {
            data[i] = {};
            data[i].date = dates[i];
            data[i].count = counts[i];
        }

        d3.selectAll("#graph" + prefix + num + "> *").remove();
        d3.selectAll('.axis').remove();

        svg = d3.select("#graph" + prefix + num).append("svg:svg");
        margin = {top: 20, right: 20, bottom: 30, left: 50};
        /*  width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom,*/
        width = +400 - margin.left - margin.right;
        height = +200 - margin.top - margin.bottom;
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        x = d3.scaleTime().range([0, width]);
        y = d3.scaleLinear().range([height, 0]);

        line = d3.line()
            .curve(d3.curveBasis)
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.count); });


        x.domain(d3.extent(data, function(d) { return d.date; }));
        y.domain(d3.extent(data, function(d) { return d.count; }));

        g.append("svg:g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x))
            .select(".domain")
            .remove();

        g.append("svg:g")
            .call(d3.axisLeft(y))
            .append("text")
            .attr("fill", "#000")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end")
            .text(text);

        g.append("svg:path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-linejoin", "round")
            .attr("stroke-linecap", "round")
            .attr("stroke-width", 1.5)
            .attr("d", line);
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ignite Teamcity - comparison master's branch in the date interval</title>
    <link rel="icon" href="img/leaf-icon-png-7066.png">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="css/style-1.5.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"
          integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <script src="js/common-1.6.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<br>
<br>

<table class="compare"  width="100%">
    <tr>
        <th class="section"  width="13%">DATE INTERVAL</th>
        <th width="3%"></th>
        <th style="text-align: center;" width="42%"><input type='text' name='daterange1'/></th>
        <th style="text-align: center;" width="42%"><input type='text' name='daterange2'/></th>
    </tr>
    <tr id="showInfo">
        <td class="section">SHOW INVALID BUILD</td>
        <td class="icon"><div class="switch-btn"></div></td>
        <td style="text-align: center;" id="info1"></td>
        <td style="text-align: center;" id="info2"></td>
    </tr>
    <tr><td class="field">DURATION</td>
        <td class="icon"><img id="clickGraphDuration" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Duration1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="Duration2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphDuration" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphDuration1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphDuration2" width="500" height="200"></svg></td>
    </tr><tr></tr>
    <tr><td class="section">TESTS</td><td></td><td class="title mmm1"></td><td class="title mmm2"></td></tr>
    <tr><td class="field">COUNT</td>
        <td class="icon"><img id="clickGraphCount" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Count1" data-allow-highlight="false"></td>
        <td class="mmm2 data2" id="Count2" data-allow-highlight="false"></td>
    </tr>
    <tr id="showGraphCount" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphCount1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphCount2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">PASSED</td>
        <td class="icon"><img id="clickGraphPassed" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Passed1" data-allow-highlight="false"></td>
        <td class="mmm2 data2" id="Passed2" data-allow-highlight="false"></td>
    </tr>
    <tr id="showGraphPassed" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphPassed1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphPassed2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">FAILED</td>
        <td class="icon"><img id="clickGraphFailed" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Failed1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="Failed2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphFailed" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphFailed1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphFailed2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">IGNORED</td>
        <td class="icon"><img id="clickGraphIgnored" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Ignored1" data-allow-highlight="false"></td>
        <td class="mmm2 data2" id="Ignored2" data-allow-highlight="false"></td>
    </tr>
    <tr id="showGraphIgnored" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphIgnored1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphIgnored2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">MUTED</td>
        <td class="icon"><img id="clickGraphMuted" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="Muted1" data-allow-highlight="false"></td>
        <td class="mmm2 data2" id="Muted2" data-allow-highlight="false"></td></tr>
    <tr id="showGraphMuted" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphMuted1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphMuted2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="section">PROBLEMS</td><td></td><td class="title mmm1"></td><td class="title mmm2"></td></tr>
    <tr style="display: none;"><td></td><td></td><td></td></tr>
    <tr><td class="field">TOTAL</td>
        <td class="icon"><img id="clickGraphTT" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="TT1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="TT2" data-allow-highlight="true"></td></tr>
    <tr id="showGraphTT" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphTT1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphTT2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">EXECUTION TIMEOUT</td>
        <td class="icon"><img id="clickGraphET" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="ET1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="ET2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphET" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphET1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphET2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">JVM CRASH</td>
        <td class="icon"><img id="clickGraphJC" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="JC1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="JC2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphJC" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphJC1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphJC2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">OOME</td>
        <td class="icon"><img id="clickGraphOO" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="OO1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="OO2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphOO" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphOO1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphOO2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="field">EXIT CODE</td>
        <td class="icon"><img id="clickGraphEC" src='/img/browser.png'></td>
        <td class="mmm1 data1" id="EC1" data-allow-highlight="true"></td>
        <td class="mmm2 data2" id="EC2" data-allow-highlight="true"></td>
    </tr>
    <tr id="showGraphEC" style="display: none;"><td></td>
        <td></td>
        <td style="text-align: center;"><svg id="graphEC1" width="500" height="200"></svg></td>
        <td style="text-align: center;"><svg id="graphEC2" width="500" height="200"></svg></td>
    </tr>
    <tr><td class="section">OTHER METRICS</td><td></td><td class="title t1"></td><td class="title t2"></td></tr>
    <tr style="display: none;"><td></td><td></td><td></td></tr>
    <tr><td class="field">RUNS COUNT</td>
        <td></td>
        <td class="t1 data1" id="RunsCount1"></td>
        <td class="t2 data2" id="RunsCount2"></td>
    </tr>
</table><br>
<div id="version"></div>
<script>
    let oneWeekAgo = new Date(),
        twoWeekAgo = new Date(),
        g_updTimer = null,
        invalidInclude = false,
        markBuildId = 0;

    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    twoWeekAgo.setDate(twoWeekAgo.getDate() - 14);

    const parseTime = d3.timeParse("%d-%m-%YT%H:%M:%S"),
        formatTime = d3.timeFormat("%d-%m-%Y %H:%M:%S"),
        formatMillisecond = d3.timeFormat(".%L"),
        formatSecond = d3.timeFormat(":%S"),
        formatMinute = d3.timeFormat("%H:%M"),
        formatHour = d3.timeFormat("%H:%M"),
        formatDay = d3.timeFormat("%a %e"),
        formatWeek = d3.timeFormat("%b %e"),
        formatMonth = d3.timeFormat("%B"),
        formatYear = d3.timeFormat("%Y"),
        parseDuration = d3.utcParse("%s");

    const tOcc = ["Count", "Passed", "Failed", "Ignored", "Muted"],
        prOcc = ["TT", "ET", "JC", "OO", "EC"],
        prOccFull = {"TT" : "Total", "ET" : "Execution timeout", "JC" : "JVM crash", "OO" : "OOME", "EC" : "Exit code"},
        mmmTitle = "min - median - max",
        tTitle = "total",
        duration = "Duration",
        data = {},
        invalidBuildsList = new Set(),
        validBuildsList = new Set();

    data[1] = {};
    data[2] = {};
    data[1]['num'] = 1;
    data[2]['num'] = 2;

    function multiFormat(date) {
        return (d3.timeSecond(date) < date ? formatMillisecond
            : d3.timeMinute(date) < date ? formatSecond
                : d3.timeHour(date) < date ? formatMinute
                    : d3.timeDay(date) < date ? formatHour
                        : d3.timeMonth(date) < date ? (d3.timeWeek(date) < date ? formatDay : formatWeek)
                            : d3.timeYear(date) < date ? formatMonth
                                : formatYear)(date);
    }

    function dateRangePickerParam(startDate, endDate) {
        return {
            "opens" : 'left',
            "maxSpan": { "days": 7 },
            "locale": {
                "format": "DD/MM/YYYY", "separator": " - ", "applyLabel": "Apply", "cancelLabel": "Cancel",
                "fromLabel": "From", "toLabel": "To", "customRangeLabel": "Custom", "weekLabel": "W",
                "daysOfWeek": [ "Su", "Mo", "Tu", "We", "Th", "Fr", "Sa" ],
                "monthNames": [ "January", "February", "March", "April", "May", "June", "July",
                    "August", "September", "October", "November", "December" ],
                "firstDay": 1
            },
            "startDate": moment(startDate).format("DD-MM-YYYY"), "endDate": moment(endDate).format("DD-MM-YYYY")
        }
    }

    function getMinMaxMedian(arr) {
        let newArr = arr.slice();
        newArr = newArr.sort(function(a, b){ return a - b; });

        let i = newArr.length / 2;

        let result = {};
        result.median = i % 1 === 0 ? (newArr[i - 1] + newArr[i]) / 2 : newArr[Math.floor(i)];
        result.min = newArr[0];
        result.max = newArr[newArr.length - 1];

        return result;
    }

    function parseMedian(string) {
        let stringMedian = string.substring(string.indexOf("-") + 2, string.lastIndexOf("-") - 1);

        if (stringMedian.indexOf(":") !== -1)
            return (parseInt(stringMedian.split(":")[0]) * 60 + parseInt(stringMedian.split(":")[1])) * 60;
        else
            return parseFloat(stringMedian);
    }

    function printStatistics(result) {
        let num = result['num'],
            fullMap = result['map'],
            onlyValidMap = getOnlyValid(fullMap),
            hiddenBuildsCount = fullMap.length - onlyValidMap.length,
            map = invalidInclude ? fullMap : onlyValidMap,
            sinceDate = result['sinceDate'],
            untilDate = result['untilDate'];

        clearBackgroundFromAllDataCells();
        clearGraphs(num);

        let statistics = {},
            dates = [],
            buildIds = [];

        statistics[duration] = [];

        for (let i = 0; i < prOcc.length; i++) {
            statistics[prOcc[i]] = [];
            statistics[tOcc[i]] = [];
        }

        for (let j = 0; j < map.length; j++) {
            dates[j] = parseTime(map[j].startDate);
            buildIds[j] = map[j].buildId;
            statistics[duration][j] = map[j].duration;

            for (let i = 0; i < prOcc.length; i++) {
                statistics[prOcc[i]][j] = map[j].totalProblems[prOcc[i]];
                statistics[tOcc[i]][j] = map[j].testOccurrences[tOcc[i].toLowerCase()];
            }
        }

        if (map.length === 0) {
            printImportantMessage(num, "#ff0000", "No data for the selected period");
            fillAllDataCells(num, "");
            $('.title.mmm' + num).html("");

            if (!(invalidInclude || (hiddenBuildsCount === 0)))
                printRunsCount();
            else
                $('.title.t' + num).html("");

            return;
        } else {
            let firstDate = moment(parseTime(map[0].startDate)).format("DD-MM-YYYY");
            let lastDate = moment(parseTime(map[map.length - 1].startDate)).format("DD-MM-YYYY");

            if ((sinceDate.format("DD-MM-YYYY") !== firstDate) || (untilDate.format("DD-MM-YYYY") !== lastDate)) {
                printImportantMessage(num, "#ffb856", "Data for " +
                    (firstDate === lastDate ? firstDate : ("the period from " + firstDate + " to " + lastDate)) + "");
            } else
                $("#info" + num).html("");

        }

        $('.title.mmm' + num).html(mmmTitle);
        $('.mmm' + num).prop('title', mmmTitle);
        $('.title.t' + num).html(tTitle);
        $('.t' + num).prop('title', tTitle);

        fillCellWithStatistics(duration, num, statistics, dates, buildIds);

        for (let i = 0; i < prOcc.length; i++) {
            fillCellWithStatistics(prOcc[i], num, statistics, dates, buildIds);
            fillCellWithStatistics(tOcc[i], num, statistics, dates, buildIds);
        }

        printRunsCount();

        function printRunsCount(){
            $('#RunsCount' + num).html(map.length + "<br>" + (invalidInclude || (hiddenBuildsCount === 0) ? "" :
                "<span class='compare title'>(" + (fullMap.length - onlyValidMap.length) +
                " invalid builds hide)</span>"));
        }
    }

    function getOnlyValid(map) {
        let validMap = [];

        for (let i = 0; i < map.length; i++) {
            if (map[i].isValid) {
                if (!invalidBuildsList.has(map[i].buildId))
                    validMap.push(map[i]);
            } else {
                if (validBuildsList.has(map[i].buildId))
                    validMap.push(map[i]);
                else
                    invalidBuildsList.add(map[i].buildId);
            }
        }

        return validMap;
    }

    function fillCellWithStatistics(prefix, num, statistics, dates, buildIds) {
        let result = getMinMaxMedian(statistics[prefix]);

        if (prefix === duration)
            $('#' + prefix + num).html(time(result.min) + " - " + time(result.median) + " - " + time(result.max));
        else
            $('#' + prefix + num).html(result.min + " - " + result.median +  " - " + result.max);

        compareAndHighlight(prefix, num, result.median);

        drawGraph(prefix, num, dates, statistics[prefix], buildIds, result.median);

        function time(ms){
            return moment(ms * 1000).utcOffset(0).format("H:mm");
        }
    }

    function compareAndHighlight(prefix, thisNum, thisMedian){
        let anotherNum = (thisNum === 1) ? 2 : 1,
            thisElement = $('#' + prefix + thisNum),
            anotherElement =  $('#' + prefix + anotherNum);

        if (thisElement.data('allowHighlight').toString() === "true") {
            let anotherMedian = parseMedian(anotherElement.text());
            if (!isNaN(anotherMedian)) {
                if (thisMedian > anotherMedian) {
                    thisElement.css('background-color', '#ffeee9');
                    anotherElement.css('background-color', '#e5ffe8');
                } else if (thisMedian < anotherMedian) {
                    anotherElement.css('background-color', '#ffeee9');
                    thisElement.css('background-color', '#e5ffe8');
                }
            }
        }
    }

    $(document).ready(function() {
        loadData(1, moment(oneWeekAgo), moment());
        loadData(2, moment(twoWeekAgo), moment(oneWeekAgo));

        $.ajax({ url: "rest/branches/version",  success: showVersionInfo, error: showErrInLoadStatus });

        if(g_updTimer == null) {
            g_updTimer = setTimeout(tstTimeout, 3200);
        }
        setInterval(tstTimeout, 10000);
    });

    function tstTimeout() {
        if (g_updTimer != null) {
            clearTimeout(g_updTimer);
            g_updTimer = null;
        }

        if (g_updTimer == null) {
            g_updTimer = setTimeout(tstTimeout, 3200);
        }
    }

    function clearBackgroundFromAllDataCells(num){
        $('.data' + (num == null ? '1, .data2' : num)).css('background', '');
    }

    function fillAllDataCells(num, message) {
        $('.data' + num).html(message);
    }

    function clearGraphs(num) {
        $("#graph" + duration + num).empty();
        for (let i = 0; i < prOcc.length; i++) {
            $("#graph" + prOcc[i] + num).empty();
            $("#graph" + tOcc[i] + num).empty();
        }
    }

    function loadGif(num) {
        clearBackgroundFromAllDataCells();
        clearGraphs(num);
        fillAllDataCells(num, "<img src='/img/loading.gif' width=15px height=15px>");
    }

    function printImportantMessage(num, color, message) {
        $('#info' + num).html("<span style='background:" + color + "; color:white; font-weight:bold;'>" +
            "&nbsp;&nbsp;!&nbsp;&nbsp;</span>&nbsp;&nbsp;" + message);
        $('#showInfo').css('display', '');
    }

    function loadData(num, sinceDate, untilDate) {
        loadGif(num);
        $.ajax(
            {
                url: 'rest/build/history?sinceDate=' + sinceDate.format("DDMMYYYY") +
                '000001&untilDate=' + untilDate.format("DDMMYYYY") + '235959',
                success: function (result) {
                    data[num]['map'] = result;
                    data[num]['sinceDate'] = sinceDate;
                    data[num]['untilDate'] = untilDate;

                    printStatistics(data[num]);
                },
                error: showErrInLoadStatus
            }
        );
    }

    $(function() {
        $('input[name="daterange1"]').daterangepicker(
            dateRangePickerParam(oneWeekAgo, new Date()), function (start, end) {
                loadData(1, start, end);
            });
    });

    $(function() {
        $('input[name="daterange2"]').daterangepicker(
            dateRangePickerParam(twoWeekAgo, oneWeekAgo), function (start, end) {
                loadData(2, start, end);
            });
    });

    graphSpoiler(duration);

    for (let i = 0; i < prOcc.length; i++) {
        graphSpoiler(prOcc[i]);
        graphSpoiler(tOcc[i]);
    }

    function graphSpoiler(prefix) {
        $("#clickGraph" + prefix).click(function() {
            let element = $('#showGraph' + prefix);
            element.css('display') === 'none' ? element.css('display', '') : element.css('display', 'none');
        });
    }

    function drawGraph(prefix, num, dates, counts, buildIds, median) {
        let data = [],
            isDuration = prefix === duration;

        for (let i = 0; i < dates.length; i++) {
            data[i] = {};
            data[i].date = dates[i];
            data[i].value = (isDuration ? parseDuration(parseInt(counts[i])) : counts[i]);
            data[i].buildId = buildIds[i];
        }

        let svg = d3.select("#graph" + prefix + num).append("svg:svg"),
            margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = 500 - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        let buildDate = d3.select("body").append("div").attr("class", "tooltip buildDate").style("opacity", 0),
            condition = d3.select("body").append("div").attr("class", "tooltip condition").style("opacity", 0),
            mark = d3.select("body").append("div").attr("class", "tooltip mark").style("opacity", 0);

        let y = (isDuration ? d3.scaleTime() : d3.scaleLinear()).range([height, 0]),
            x = d3.scaleTime().rangeRound([0, width]);

        let line = d3.line()
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.value); });

        x.domain(d3.extent(data, function(d) { return d.date; }));
        y.domain(d3.extent(data, function(d) { return d.value; }));

        g.append("svg:g").attr("transform", "translate(0," + (height) + ")")
            .call(d3.axisBottom(x).tickFormat(multiFormat));
        g.append("svg:g").call(isDuration ? d3.axisLeft(y).tickFormat(d3.utcFormat("%H:%M")) : d3.axisLeft(y));

        let svg_aline = g.append("line")
            .attr("class", "line")
            .style("stroke-dasharray", ("3, 10"))
            .attr("x1",100)
            .attr("x2",400)
            .attr("y1",200)
            .attr("y2",200)
            .attr("stroke", "#4682B4")
            .attr("stroke-width", "1")
            .style("display", "none");

        let median_line = g.append("line")
            .attr("class", "line")
            .attr("x1",0)
            .attr("x2",width)
            .attr("y1",y(isDuration ? parseDuration(parseInt(median)) : median))
            .attr("y2",y(isDuration ? parseDuration(parseInt(median)) : median))
            .attr("stroke", "red")
            .attr("stroke-width", "0.2")
            .style("display", "block");

        g.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-linejoin", "round")
            .attr("stroke-linecap", "round")
            .attr("stroke-width", 1.5)
            .attr("d", line);

        g.selectAll("dot").data(data)
            .enter()
            .append("circle")
            .attr("r", 3)
            .attr("cx", function(d){return x(d.date); })
            .attr("cy", function(d){return y(d.value); })
            .attr("class", function(d) {
                return getDotClass(d.buildId);
            })
            .on("mouseover", function(d) {
                d3.select(this).transition().duration(100)
                    .style("fill", "#12AD5E")
                    .attr("r", 5)
                    .attr("onclick", "checkAvailable(" + d.buildId + "," +  d.date.getTime() + ");" +
                        "return false;");

                svg_aline.transition().duration(10)
                    .style("display", "block")
                    .attr("x1", x(d.date))
                    .attr("y1", y(d.value))
                    .attr("x2", x(d.date))
                    .attr("y2", height);

                let graphTd = document.getElementById("graph" + prefix + num).getBoundingClientRect(),
                    scrollTop = window.pageYOffset || document.documentElement.scrollTop,
                    top = scrollTop + graphTd.top + y(d.value) - 10,
                    partLeft = graphTd.left + x(d.date),
                    buildDateNearTheBorder = x(d.date) > (440 - 140);

                buildDate.html(formatTime(d.date))
                    .style("left", partLeft + (buildDateNearTheBorder ? -99 : 49) + "px")
                    .style("top", top + "px" ).transition()
                    .duration(200).style("opacity", .8).style("display", "block");

                mark.html('<i class="fas fa-' + (markBuildId === d.buildId ? 'eraser' : 'highlighter') + '"></i>')
                    .style("left", partLeft + (buildDateNearTheBorder ? 49 : 23) + "px")
                    .style("top", top + "px" )
                    .attr("onclick", "markBuild(" + d.buildId + "); return false;").transition()
                    .duration(200).style("opacity", .8).style("display", "block");

                condition.html('<i class="' + (invalidBuildsList.has(d.buildId) ? 'fas fa-undo' : 'far fa-trash')
                    + '-alt"></i>')
                    .style("left", partLeft + (buildDateNearTheBorder ? 75 : -3) + "px")
                    .style("top", top + "px" )
                    .attr("onclick", "setCondition(" + num + ", " + d.buildId + ", " +
                        (isDuration ? d.value.getTime() / 1000 : d.value) +
                        ", " + median + ", '" + prefix + "'); return false;").transition()
                    .duration(200).style("opacity", .8).style("display", "block");
            })

            .on("mouseout", function(d) {
                d3.select(this).transition().duration(100)
                    .style("fill", null)
                    .attr("r", 3);

                buildDate.transition().duration(2000)
                    .style("opacity", 0).on("end", function() { buildDate.style("display", "none"); });

                condition.transition().duration(2000)
                    .style("opacity", 0).on("end", function() { condition.style("display", "none"); });

                mark.transition().duration(2000)
                    .style("opacity", 0).on("end", function() { mark.style("display", "none"); });

                svg_aline.style("display","none")
            });

        function getDotClass(buildId) {
            if (markBuildId === buildId)
                return "mark-dot";
            else
                return ((invalidInclude && invalidBuildsList.has(buildId)) ? "hidden-dot" : "dot");
        }
    }

    function setCondition(num, buildId, value, median, prefix) {
        let isValid = invalidBuildsList.has(buildId);
        let modalDialog = $("#modalDialog");
        let diff = ((value / median - 1) * 100 | 0);
        let message = "<p style='text-align:center;opacity: 0.7;'><img src='img/tc.svg' width='100' height='100'></p>" +
            "<br><p style='text-align:justify'><b>Build [" + buildId +  "]</b> will be marked as &laquo;" +
            (isValid ? "" : "in") + "valid&raquo;. Value differs by <b>" + diff + "%</b> from the median.</p>" +
            "<br><b>Field:</b>&nbsp;<select style='width: 200px'>";

        for (let i = 0; i < prOcc.length; i++)
            message += getHtmlOption(prOcc[i], false, prOcc[i] === prefix, prOccFull[prOcc[i]]);

        for (let i = 0; i < tOcc.length; i++)
            message += getHtmlOption(tOcc[i], false, tOcc[i] === prefix, tOcc[i]);

        message += getHtmlOption(duration, false, duration === prefix, duration) + "</select><br><br><b>Mark: </b>" +
            "<select style='width: 200px'>" + getHtmlOption(true, false, true, "Only for me") +
            getHtmlOption(false, true, false, "For all") + "</select>";

        message += "<br><br><span style='color:grey;font-size:smaller;text-align:justify'><hr>If you select " +
            "&laquo;Mark for all&raquo;, your request will be checked, and if successful, build will be hidden " +
            "from the results for all users, and will not be taken into account when analyzing tests.</span>";

        modalDialog.html(message);
        modalDialog.dialog({
            modal: true,
            buttons: {
                "Confirm": function () {
                    $(this).dialog("close");
                    $.ajax({
                        url: 'rest/build/condition',
                        data: {
                            "buildId": buildId,
                            "field" : prefix,
                            "isValid": isValid
                        },
                        success: function (result) {
                            let resultDialog = $("#resultDialog");
                            resultDialog.html("<p style='text-align:center'><br>" + result.result + "</p>");

                            setBuildCondition(buildId, isValid);

                            resultDialog.dialog({
                                modal: true,
                                buttons: {
                                    "Ok": function () {
                                        $(this).dialog("close");
                                    }
                                }
                            });
                        },
                        error: showErrInLoadStatus
                    });
                },
                "Cancel": function () {
                    $(this).dialog("close");
                }

            }
        });

        function getHtmlOption(value, disabled, selected, text){
            return "<option value='" + value + "' " + (disabled ? "disabled" : "") + (selected ? "selected" : "") +
                ">" + text + "</option>";
        }
    }

    function getBuildLink(buildId) { return "https://ci.ignite.apache.org/viewLog.html?buildId=" + buildId
        + "&tab=buildResultsDiv&buildTypeId=IgniteTests24Java8_RunAll"; }

    function checkAvailable(buildId, date) {
        let dateDiff = moment().diff(moment(date), 'days');

        if (dateDiff <= 14) {
            window.open(getBuildLink(buildId), '_blank');

            return;
        }

        let message = "<p style='text-align:center;opacity: 0.7;'><img src='img/tc.svg' width='100' height='100'></p>" +
            "<br>The results &laquo;Run All&raquo; for <b>build [" + buildId +  "]</b> is <b>not available</b> on " +
            "the TeamCity server.<br><br><span style='color:grey;font-size:smaller'><hr>TeamCity server stores data " +
            "for the last ~14 days. Since the launch of the build " + dateDiff + " days have passed</span>";

        let modalDialog = $("#modalDialog");

        modalDialog.html(message);
        modalDialog.dialog({
            modal: true,
            buttons: {
                "Go anyway": function () {
                    $(this).dialog("close");
                    window.open(getBuildLink(buildId), '_blank');
                },
                "Cancel": function () {
                    $(this).dialog("close");
                }
            }
        });
    }

    function setBuildCondition(buildId, isValid) {
        if (isValid) {
            validBuildsList.add(buildId);
            invalidBuildsList.delete(buildId);
        } else {
            validBuildsList.delete(buildId);
            invalidBuildsList.add(buildId);
        }

        updateAll();
    }

    function markBuild(buildId) {
        markBuildId = (markBuildId === buildId) ? 0 : buildId;

        updateAll();
    }

    $('.switch-btn').click(function(){
        $(this).toggleClass('switch-on');

        invalidInclude = $(this).hasClass('switch-on');
        updateAll();
    });

    function updateAll() {
        printStatistics(data[1]);
        printStatistics(data[2]);
    }
</script>
<div style="visibility:hidden">
    <div id="modalDialog" title="Information"></div><div id="resultDialog" title="Result"></div>
</div>
</body>
</html>
